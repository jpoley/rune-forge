# Swift Mobile - GitHub CI/CD & Distribution

## GitHub Actions for iOS

### Basic iOS Workflow
```yaml
# .github/workflows/ios.yml
name: iOS Build and Test

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  build-and-test:
    runs-on: macos-13
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: '15.0'
        
    - name: Cache SPM packages
      uses: actions/cache@v3
      with:
        path: |
          ~/Library/Developer/Xcode/DerivedData
          ~/Library/Caches/org.swift.swiftpm
        key: ${{ runner.os }}-spm-${{ hashFiles('**/Package.resolved') }}
        restore-keys: |
          ${{ runner.os }}-spm-
          
    - name: Install dependencies
      run: |
        xcodebuild -resolvePackageDependencies -project MyApp.xcodeproj
        
    - name: Build
      run: |
        xcodebuild clean build \
          -project MyApp.xcodeproj \
          -scheme MyApp \
          -destination 'platform=iOS Simulator,name=iPhone 15' \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO
          
    - name: Test
      run: |
        xcodebuild test \
          -project MyApp.xcodeproj \
          -scheme MyApp \
          -destination 'platform=iOS Simulator,name=iPhone 15' \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO
          
    - name: Upload test results
      uses: actions/upload-artifact@v3
      if: failure()
      with:
        name: test-results
        path: TestResults/
```

### Advanced CI Pipeline
```yaml
# .github/workflows/ios-advanced.yml
name: iOS Advanced Pipeline

on:
  push:
    branches: [main]
    tags: ['v*']
  pull_request:
    branches: [main]

env:
  XCODE_VERSION: '15.0'
  IOS_SIMULATOR: 'iPhone 15'

jobs:
  lint-and-format:
    runs-on: macos-13
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup SwiftLint
      run: |
        brew install swiftlint
        
    - name: SwiftLint
      run: swiftlint lint --reporter github-actions-logging
      
    - name: SwiftFormat
      run: |
        brew install swiftformat
        swiftformat --lint .

  unit-tests:
    needs: lint-and-format
    runs-on: macos-13
    strategy:
      matrix:
        destination:
          - 'platform=iOS Simulator,name=iPhone 15'
          - 'platform=iOS Simulator,name=iPad (10th generation)'
          
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: ${{ env.XCODE_VERSION }}
        
    - name: Cache dependencies
      uses: actions/cache@v3
      with:
        path: |
          ~/Library/Developer/Xcode/DerivedData
          ~/Library/Caches/org.swift.swiftpm
        key: ${{ runner.os }}-${{ env.XCODE_VERSION }}-${{ hashFiles('**/Package.resolved', '**/Podfile.lock') }}
        
    - name: Install dependencies
      run: |
        if [ -f "Podfile" ]; then
          gem install bundler
          bundle install
          bundle exec pod install
        fi
        
    - name: Run tests
      run: |
        xcodebuild test \
          -workspace MyApp.xcworkspace \
          -scheme MyApp \
          -destination '${{ matrix.destination }}' \
          -enableCodeCoverage YES \
          -derivedDataPath DerivedData
          
    - name: Upload coverage
      uses: codecov/codecov-action@v3
      with:
        file: DerivedData/Logs/Test/*.xcresult
        fail_ci_if_error: false

  ui-tests:
    needs: unit-tests
    runs-on: macos-13
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: ${{ env.XCODE_VERSION }}
        
    - name: Run UI Tests
      run: |
        xcodebuild test \
          -workspace MyApp.xcworkspace \
          -scheme MyApp \
          -destination 'platform=iOS Simulator,name=${{ env.IOS_SIMULATOR }}' \
          -only-testing:MyAppUITests
          
    - name: Upload UI test artifacts
      uses: actions/upload-artifact@v3
      if: failure()
      with:
        name: ui-test-screenshots
        path: ~/Library/Logs/DiagnosticReports/

  build-and-archive:
    if: github.event_name == 'push' && contains(github.ref, 'refs/tags/')
    needs: [unit-tests, ui-tests]
    runs-on: macos-13
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: ${{ env.XCODE_VERSION }}
        
    - name: Import signing certificate
      env:
        P12_CERTIFICATE: ${{ secrets.P12_CERTIFICATE }}
        P12_PASSWORD: ${{ secrets.P12_PASSWORD }}
        KEYCHAIN_PASSWORD: ${{ secrets.KEYCHAIN_PASSWORD }}
      run: |
        # Create keychain
        security create-keychain -p "$KEYCHAIN_PASSWORD" build.keychain
        security default-keychain -s build.keychain
        security unlock-keychain -p "$KEYCHAIN_PASSWORD" build.keychain
        security set-keychain-settings -t 3600 -u build.keychain
        
        # Import certificate
        echo "$P12_CERTIFICATE" | base64 --decode > certificate.p12
        security import certificate.p12 -k build.keychain -P "$P12_PASSWORD" -T /usr/bin/codesign
        security set-key-partition-list -S apple-tool:,apple:,codesign: -s -k "$KEYCHAIN_PASSWORD" build.keychain
        
    - name: Install provisioning profile
      env:
        PROVISIONING_PROFILE: ${{ secrets.PROVISIONING_PROFILE }}
      run: |
        mkdir -p ~/Library/MobileDevice/Provisioning\ Profiles
        echo "$PROVISIONING_PROFILE" | base64 --decode > ~/Library/MobileDevice/Provisioning\ Profiles/MyApp.mobileprovision
        
    - name: Archive
      run: |
        xcodebuild archive \
          -workspace MyApp.xcworkspace \
          -scheme MyApp \
          -destination 'generic/platform=iOS' \
          -archivePath MyApp.xcarchive \
          CODE_SIGNING_REQUIRED=YES
          
    - name: Export IPA
      run: |
        xcodebuild -exportArchive \
          -archivePath MyApp.xcarchive \
          -exportPath Export/ \
          -exportOptionsPlist ExportOptions.plist
          
    - name: Upload to App Store Connect
      env:
        APP_STORE_CONNECT_API_KEY: ${{ secrets.APP_STORE_CONNECT_API_KEY }}
      run: |
        xcrun altool --upload-app \
          --type ios \
          --file Export/MyApp.ipa \
          --apiKey "$APP_STORE_CONNECT_API_KEY" \
          --apiIssuer ${{ secrets.APP_STORE_CONNECT_ISSUER_ID }}
```

## Xcode Cloud Integration

### Xcode Cloud Configuration
```yaml
# ci_post_xcodebuild.sh
#!/bin/bash

if [[ $CI_XCODEBUILD_ACTION == "archive" ]]; then
    echo "Archiving completed"
    
    # Custom post-archive actions
    if [[ -n $CI_ARCHIVE_PATH ]]; then
        echo "Archive path: $CI_ARCHIVE_PATH"
        
        # Upload to crash reporting
        ./scripts/upload_symbols.sh "$CI_ARCHIVE_PATH"
        
        # Notify team
        curl -X POST "$SLACK_WEBHOOK_URL" \
             -H 'Content-type: application/json' \
             --data "{\"text\":\"iOS build archived successfully for $CI_BRANCH\"}"
    fi
fi

# Environment-specific configurations
if [[ $CI_BRANCH == "main" ]]; then
    echo "Production build configuration"
    export API_BASE_URL="https://api.production.com"
elif [[ $CI_BRANCH == "develop" ]]; then
    echo "Staging build configuration"
    export API_BASE_URL="https://api.staging.com"
fi
```

### Build Environment Setup
```bash
# ci_pre_xcodebuild.sh
#!/bin/bash

echo "Setting up build environment..."

# Install dependencies
if [[ -f "Podfile" ]]; then
    echo "Installing CocoaPods dependencies..."
    gem install bundler
    bundle install
    bundle exec pod install --repo-update
fi

# Swift Package Manager
echo "Resolving Swift packages..."
xcodebuild -resolvePackageDependencies

# Environment configuration
echo "Configuring build environment for branch: $CI_BRANCH"

case $CI_BRANCH in
    "main")
        cp Config/Production.plist Config/Environment.plist
        ;;
    "develop")
        cp Config/Staging.plist Config/Environment.plist
        ;;
    *)
        cp Config/Development.plist Config/Environment.plist
        ;;
esac

# Version management
BUILD_NUMBER=$CI_BUILD_NUMBER
if [[ -z "$BUILD_NUMBER" ]]; then
    BUILD_NUMBER=$(git rev-list --count HEAD)
fi

/usr/libexec/PlistBuddy -c "Set :CFBundleVersion $BUILD_NUMBER" Info.plist
echo "Set build number to: $BUILD_NUMBER"
```

## App Store Connect Integration

### Fastlane Configuration
```ruby
# fastlane/Fastfile
default_platform(:ios)

platform :ios do
  before_all do
    setup_circle_ci if ENV['CI']
  end

  desc "Run tests"
  lane :test do
    run_tests(
      workspace: "MyApp.xcworkspace",
      devices: ["iPhone 15", "iPad (10th generation)"],
      scheme: "MyApp"
    )
  end

  desc "Build and upload to TestFlight"
  lane :beta do
    increment_build_number(xcodeproj: "MyApp.xcodeproj")
    
    build_app(
      workspace: "MyApp.xcworkspace",
      scheme: "MyApp",
      export_method: "app-store"
    )
    
    upload_to_testflight(
      beta_app_review_info: {
        contact_email: "developer@example.com",
        contact_first_name: "John",
        contact_last_name: "Doe",
        contact_phone: "555-123-4567",
        demo_account_name: "demo@example.com",
        demo_account_password: "demo123",
        notes: "Thank you for reviewing our app!"
      },
      localized_app_info: {
        "default": {
          feedback_email: "feedback@example.com",
          marketing_url: "https://example.com",
          privacy_policy_url: "https://example.com/privacy",
          description: "App description for TestFlight"
        }
      }
    )
  end

  desc "Deploy to App Store"
  lane :release do
    increment_build_number(xcodeproj: "MyApp.xcodeproj")
    
    build_app(
      workspace: "MyApp.xcworkspace",
      scheme: "MyApp",
      export_method: "app-store"
    )
    
    upload_to_app_store(
      force: true,
      reject_if_possible: true,
      skip_metadata: false,
      skip_screenshots: false,
      submit_for_review: true,
      automatic_release: false,
      submission_information: {
        add_id_info_uses_idfa: false,
        add_id_info_serves_ads: false,
        add_id_info_tracks_install: false,
        add_id_info_tracks_action: false,
        add_id_info_limits_tracking: true,
        content_rights_has_rights: true,
        content_rights_contains_third_party_content: false,
        export_compliance_platform: 'ios',
        export_compliance_compliance_required: false,
        export_compliance_encryption_updated: false,
        export_compliance_app_type: nil,
        export_compliance_uses_encryption: false,
        export_compliance_is_exempt: false,
        export_compliance_contains_third_party_cryptography: false,
        export_compliance_contains_proprietary_cryptography: false,
        export_compliance_available_on_french_store: false
      }
    )
  end

  desc "Take screenshots"
  lane :screenshots do
    capture_screenshots
    upload_to_app_store(skip_binary_upload: true)
  end

  error do |lane, exception|
    slack(
      message: "Lane #{lane} failed with exception: #{exception}",
      success: false
    )
  end
end
```

### GitHub Actions + Fastlane
```yaml
# .github/workflows/fastlane.yml
name: Fastlane iOS

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

jobs:
  test:
    runs-on: macos-13
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.1'
        bundler-cache: true
        
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: '15.0'
        
    - name: Cache CocoaPods
      uses: actions/cache@v3
      with:
        path: Pods
        key: ${{ runner.os }}-pods-${{ hashFiles('**/Podfile.lock') }}
        
    - name: Install dependencies
      run: |
        bundle install
        bundle exec pod install
        
    - name: Run tests
      run: bundle exec fastlane test

  deploy_testflight:
    if: github.ref == 'refs/heads/develop'
    needs: test
    runs-on: macos-13
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.1'
        bundler-cache: true
        
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: '15.0'
        
    - name: Setup signing
      env:
        MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
        MATCH_GIT_URL: ${{ secrets.MATCH_GIT_URL }}
        APP_STORE_CONNECT_API_KEY_KEY_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_KEY_ID }}
        APP_STORE_CONNECT_API_KEY_ISSUER_ID: ${{ secrets.APP_STORE_CONNECT_API_KEY_ISSUER_ID }}
        APP_STORE_CONNECT_API_KEY_KEY: ${{ secrets.APP_STORE_CONNECT_API_KEY_KEY }}
      run: |
        echo "$APP_STORE_CONNECT_API_KEY_KEY" | base64 -d > AuthKey_$APP_STORE_CONNECT_API_KEY_KEY_ID.p8
        
    - name: Install dependencies
      run: |
        bundle install
        bundle exec pod install
        
    - name: Deploy to TestFlight
      env:
        MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
      run: bundle exec fastlane beta

  deploy_appstore:
    if: startsWith(github.ref, 'refs/tags/')
    needs: test
    runs-on: macos-13
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.1'
        bundler-cache: true
        
    - name: Setup Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: '15.0'
        
    - name: Setup signing
      env:
        MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
        APP_STORE_CONNECT_API_KEY_KEY: ${{ secrets.APP_STORE_CONNECT_API_KEY_KEY }}
      run: |
        echo "$APP_STORE_CONNECT_API_KEY_KEY" | base64 -d > AuthKey.p8
        
    - name: Install dependencies
      run: |
        bundle install
        bundle exec pod install
        
    - name: Deploy to App Store
      env:
        MATCH_PASSWORD: ${{ secrets.MATCH_PASSWORD }}
      run: bundle exec fastlane release
```

## Security & Secrets Management

### Secure CI Environment
```yaml
# Secrets configuration
secrets:
  # Code signing
  P12_CERTIFICATE: # Base64 encoded .p12 certificate
  P12_PASSWORD: # Certificate password
  PROVISIONING_PROFILE: # Base64 encoded provisioning profile
  KEYCHAIN_PASSWORD: # Temporary keychain password
  
  # App Store Connect
  APP_STORE_CONNECT_API_KEY_KEY_ID: # API Key ID
  APP_STORE_CONNECT_API_KEY_ISSUER_ID: # Issuer ID
  APP_STORE_CONNECT_API_KEY_KEY: # Base64 encoded .p8 key
  
  # Fastlane Match
  MATCH_PASSWORD: # Match repository encryption password
  MATCH_GIT_URL: # Private repository URL for certificates
  
  # Third-party services
  SLACK_WEBHOOK_URL: # Notification webhook
  FIREBASE_TOKEN: # Firebase deployment token
```

### Environment Configuration
```swift
// BuildEnvironment.swift
import Foundation

enum BuildEnvironment {
    case debug
    case staging  
    case production
    
    static var current: BuildEnvironment {
        #if DEBUG
        return .debug
        #elseif STAGING
        return .staging
        #else
        return .production
        #endif
    }
    
    var apiBaseURL: String {
        switch self {
        case .debug:
            return "https://api.dev.example.com"
        case .staging:
            return "https://api.staging.example.com"
        case .production:
            return "https://api.example.com"
        }
    }
    
    var analyticsEnabled: Bool {
        switch self {
        case .debug:
            return false
        case .staging, .production:
            return true
        }
    }
}

// Usage in app
class APIService {
    private let baseURL = BuildEnvironment.current.apiBaseURL
    
    func makeRequest() {
        // Use environment-specific URL
    }
}
```

## Monitoring & Analytics

### Build Monitoring
```yaml
# .github/workflows/monitoring.yml
name: Build Monitoring

on:
  workflow_run:
    workflows: ["iOS Build and Test"]
    types: [completed]

jobs:
  notify:
    runs-on: ubuntu-latest
    steps:
    - name: Notify build status
      uses: 8398a7/action-slack@v3
      with:
        status: custom
        custom_payload: |
          {
            "text": "iOS Build ${{ github.workflow }} - ${{ job.status }}",
            "attachments": [{
              "color": "${{ job.status }}" === "success" ? "good" : "danger",
              "fields": [{
                "title": "Repository",
                "value": "${{ github.repository }}",
                "short": true
              }, {
                "title": "Branch",
                "value": "${{ github.ref }}",
                "short": true
              }, {
                "title": "Commit",
                "value": "${{ github.sha }}",
                "short": true
              }, {
                "title": "Author",
                "value": "${{ github.actor }}",
                "short": true
              }]
            }]
          }
      env:
        SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
```

### Performance Tracking
```swift
// BuildMetrics.swift
import Foundation
import OSLog

struct BuildMetrics {
    static let logger = Logger(subsystem: "com.example.myapp", category: "build")
    
    static func trackBuildInfo() {
        let buildInfo = [
            "build_number": Bundle.main.buildNumber,
            "version": Bundle.main.versionNumber,
            "environment": BuildEnvironment.current.rawValue,
            "build_date": ISO8601DateFormatter().string(from: Date()),
            "commit_hash": gitCommitHash()
        ]
        
        logger.info("Build info: \(buildInfo)")
        
        #if !DEBUG
        // Send to analytics service
        Analytics.track("app_launch", properties: buildInfo)
        #endif
    }
    
    private static func gitCommitHash() -> String {
        // Embed git commit hash during build
        return Bundle.main.infoDictionary?["GitCommitHash"] as? String ?? "unknown"
    }
}

extension Bundle {
    var versionNumber: String {
        infoDictionary?["CFBundleShortVersionString"] as? String ?? "1.0.0"
    }
    
    var buildNumber: String {
        infoDictionary?["CFBundleVersion"] as? String ?? "1"
    }
}
```

## Best Practices

### CI/CD Pipeline Optimization
- Use caching for dependencies and derived data
- Parallelize test execution across devices
- Implement proper secret management
- Monitor build times and optimize bottlenecks
- Use matrix builds for multiple configurations
- Implement proper error handling and notifications

### Security Considerations
- Never commit certificates or keys to repository
- Use encrypted secret storage (GitHub Secrets, etc.)
- Rotate signing certificates regularly
- Implement proper access controls for CI/CD
- Audit third-party dependencies regularly
- Use signed commits for security-critical changes

### Deployment Strategy
- Implement staged rollouts (TestFlight â†’ App Store)
- Use feature flags for gradual feature releases
- Maintain rollback capabilities
- Monitor crash reports and performance metrics
- Implement automated testing for critical user flows
- Document release processes and requirements