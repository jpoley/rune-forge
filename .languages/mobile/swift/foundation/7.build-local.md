# Swift Mobile - Local Build System

## Xcode Build System Overview

### Build Process Flow
```
Source Code â†’ Compiler (swiftc) â†’ Object Files â†’ Linker â†’ Executable/Framework
     â†“
Static Analysis â†’ Type Checking â†’ Optimization â†’ Code Generation
```

### Swift Compilation Phases
1. **Parse**: Source to AST
2. **Semantic Analysis**: Type checking, name binding
3. **SIL Generation**: Swift Intermediate Language
4. **SIL Optimization**: Performance optimizations
5. **IR Generation**: LLVM IR generation
6. **LLVM Optimization**: Target-specific optimizations
7. **Assembly Generation**: Machine code generation

## Xcode Project Structure

### Key Build Files
```
MyApp.xcodeproj/
â”œâ”€â”€ project.pbxproj              # Build settings, targets, files
â”œâ”€â”€ xcshareddata/
â”‚   â””â”€â”€ xcschemes/               # Build schemes
â””â”€â”€ xcuserdata/                  # User-specific settings

MyApp.xcworkspace/               # When using CocoaPods/SPM
â”œâ”€â”€ contents.xcworkspacedata
â””â”€â”€ xcshareddata/
```

### Build Settings Hierarchy
```
Project Settings
    â†“
Target Settings (override project)
    â†“
Scheme Settings (override target)
    â†“
Environment Variables (runtime override)
```

## Command Line Building

### Using xcodebuild
```bash
# Build iOS app
xcodebuild -project MyApp.xcodeproj \
           -scheme MyApp \
           -destination 'platform=iOS Simulator,name=iPhone 15' \
           build

# Build for device
xcodebuild -project MyApp.xcodeproj \
           -scheme MyApp \
           -destination 'generic/platform=iOS' \
           build

# Archive for distribution
xcodebuild -project MyApp.xcodeproj \
           -scheme MyApp \
           -destination 'generic/platform=iOS' \
           archive \
           -archivePath MyApp.xcarchive

# Export IPA
xcodebuild -exportArchive \
           -archivePath MyApp.xcarchive \
           -exportPath Export/ \
           -exportOptionsPlist ExportOptions.plist
```

### Using Swift Package Manager
```bash
# Build Swift package
swift build

# Build for release
swift build -c release

# Build for iOS (when applicable)
swift build -Xswiftc "-sdk" -Xswiftc "`xcrun --sdk iphoneos --show-sdk-path`" \
            -Xswiftc "-target" -Xswiftc "arm64-apple-ios15.0"

# Test package
swift test

# Generate Xcode project
swift package generate-xcodeproj
```

## Build Configurations

### Debug vs Release
```swift
// Build configuration detection
#if DEBUG
    print("Debug build")
#else
    print("Release build")
#endif

// Custom build flags
#if DEVELOPMENT
    let apiURL = "https://dev-api.example.com"
#elseif STAGING
    let apiURL = "https://staging-api.example.com"
#else
    let apiURL = "https://api.example.com"
#endif
```

### Build Settings Configuration
```
// Common iOS Build Settings
IPHONEOS_DEPLOYMENT_TARGET = 15.0
SWIFT_VERSION = 5.9
TARGETED_DEVICE_FAMILY = 1,2  // iPhone and iPad
CODE_SIGN_STYLE = Automatic
DEVELOPMENT_TEAM = YOUR_TEAM_ID

// Debug Configuration
SWIFT_OPTIMIZATION_LEVEL = -Onone
SWIFT_ACTIVE_COMPILATION_CONDITIONS = DEBUG
GCC_PREPROCESSOR_DEFINITIONS = DEBUG=1

// Release Configuration
SWIFT_OPTIMIZATION_LEVEL = -O
SWIFT_COMPILATION_MODE = wholemodule
DEAD_CODE_STRIPPING = YES
```

## Dependency Management

### Swift Package Manager Integration
```swift
// Package.swift for iOS framework
// swift-tools-version: 5.9
import PackageDescription

let package = Package(
    name: "MyLibrary",
    platforms: [
        .iOS(.v15),
        .macOS(.v12),
        .tvOS(.v15),
        .watchOS(.v8)
    ],
    products: [
        .library(name: "MyLibrary", targets: ["MyLibrary"])
    ],
    dependencies: [
        .package(url: "https://github.com/Alamofire/Alamofire.git", from: "5.8.0"),
        .package(url: "https://github.com/realm/realm-swift.git", from: "10.44.0")
    ],
    targets: [
        .target(
            name: "MyLibrary",
            dependencies: ["Alamofire", .product(name: "RealmSwift", package: "realm-swift")],
            path: "Sources"
        ),
        .testTarget(
            name: "MyLibraryTests",
            dependencies: ["MyLibrary"],
            path: "Tests"
        )
    ]
)
```

### CocoaPods Integration
```ruby
# Podfile
platform :ios, '15.0'
use_frameworks!

target 'MyApp' do
  pod 'Alamofire', '~> 5.8'
  pod 'RealmSwift', '~> 10.44'
  pod 'SnapKit', '~> 5.6'
  
  target 'MyAppTests' do
    inherit! :search_paths
    pod 'Quick'
    pod 'Nimble'
  end
end

post_install do |installer|
  installer.pods_project.targets.each do |target|
    target.build_configurations.each do |config|
      config.build_settings['IPHONEOS_DEPLOYMENT_TARGET'] = '15.0'
    end
  end
end
```

## Build Optimization

### Compilation Speed
```bash
# Enable parallel compilation
SWIFT_ENABLE_BATCH_MODE = YES

# Reduce debug info size
DEBUG_INFORMATION_FORMAT = dwarf

# Whole module optimization for release
SWIFT_COMPILATION_MODE = wholemodule
SWIFT_OPTIMIZATION_LEVEL = -O

# Build timing analysis
xcodebuild -project MyApp.xcodeproj \
           -scheme MyApp \
           -destination 'platform=iOS Simulator,name=iPhone 15' \
           build \
           OTHER_SWIFT_FLAGS="-Xfrontend -debug-time-compilation"
```

### Build Cache Optimization
```bash
# Clean build folder
xcodebuild clean

# Clean derived data
rm -rf ~/Library/Developer/Xcode/DerivedData

# Use build cache (Xcode Cloud)
xcodebuild -project MyApp.xcodeproj \
           -scheme MyApp \
           -destination 'platform=iOS Simulator,name=iPhone 15' \
           build \
           -enableCodeCoverage NO \
           -derivedDataPath ./DerivedData
```

## Testing Integration

### Unit Test Configuration
```swift
// XCTest target configuration
import XCTest
@testable import MyApp

class MyAppTests: XCTestCase {
    override func setUpWithError() throws {
        continueAfterFailure = false
    }
    
    func testExample() throws {
        // Test implementation
    }
    
    func testPerformanceExample() throws {
        measure {
            // Performance test
        }
    }
}
```

### UI Test Configuration
```swift
// UI Test target
import XCTest

class MyAppUITests: XCTestCase {
    override func setUpWithError() throws {
        continueAfterFailure = false
        XCUIApplication().launch()
    }
    
    func testMainFlow() throws {
        let app = XCUIApplication()
        
        // UI test implementation
        let button = app.buttons["Login"]
        XCTAssertTrue(button.exists)
        button.tap()
    }
}
```

## Code Signing

### Automatic Signing Setup
```
// Xcode Project Settings
CODE_SIGN_STYLE = Automatic
DEVELOPMENT_TEAM = YOUR_TEAM_ID
PRODUCT_BUNDLE_IDENTIFIER = com.yourcompany.myapp

// Capabilities
App Sandbox = NO (iOS apps)
Keychain Sharing = YES (if needed)
Push Notifications = YES (if needed)
```

### Manual Signing
```bash
# Create provisioning profile
# Download from Apple Developer Portal

# Sign manually
codesign --force \
         --sign "iPhone Distribution: Your Company" \
         --entitlements MyApp.entitlements \
         MyApp.app

# Verify signature
codesign --verify --verbose MyApp.app
```

## Build Scripts

### Pre/Post Build Scripts
```bash
#!/bin/bash
# Run script phase example

# Pre-build: Version increment
BUILD_NUMBER=$(git rev-list --count HEAD)
/usr/libexec/PlistBuddy -c "Set :CFBundleVersion $BUILD_NUMBER" "${INFOPLIST_FILE}"

# Post-build: Archive cleanup
if [ "${CONFIGURATION}" = "Release" ]; then
    echo "Cleaning up debug symbols..."
    find "${BUILT_PRODUCTS_DIR}" -name "*.dSYM" -exec rm -rf {} +
fi

# SwiftLint integration
if command -v swiftlint >/dev/null 2>&1; then
    swiftlint
else
    echo "warning: SwiftLint not installed"
fi
```

### Custom Build Tools
```swift
// Build configuration script
import Foundation

struct BuildConfiguration {
    static func setup() {
        #if DEBUG
        setupDebugEnvironment()
        #else
        setupReleaseEnvironment()
        #endif
    }
    
    private static func setupDebugEnvironment() {
        // Debug-specific setup
        UserDefaults.standard.set(true, forKey: "DebugMode")
        print("ðŸ”§ Debug environment configured")
    }
    
    private static func setupReleaseEnvironment() {
        // Release-specific setup
        UserDefaults.standard.removeObject(forKey: "DebugMode")
    }
}

// AppDelegate integration
@main
struct MyApp: App {
    init() {
        BuildConfiguration.setup()
    }
    
    var body: some Scene {
        WindowGroup {
            ContentView()
        }
    }
}
```

## Build Troubleshooting

### Common Build Issues
```bash
# Module not found
# Solution: Check import statements, build targets

# Linker errors
# Solution: Check library linking, framework search paths

# Code signing issues
# Solution: Verify certificates, provisioning profiles

# Swift version conflicts
# Solution: Set SWIFT_VERSION consistently across targets

# Derived data corruption
rm -rf ~/Library/Developer/Xcode/DerivedData

# Reset package cache
File â†’ Packages â†’ Reset Package Caches (Xcode)
swift package clean
swift package reset
```

### Build Performance Analysis
```bash
# Build time analysis
xcodebuild -project MyApp.xcodeproj \
           -scheme MyApp \
           build \
           OTHER_SWIFT_FLAGS="-Xfrontend -debug-time-compilation" | \
           grep -E "^[0-9]+\.[0-9]+ms" | \
           sort -nr | \
           head -20

# Memory usage during build
xcodebuild -project MyApp.xcodeproj \
           -scheme MyApp \
           build \
           OTHER_SWIFT_FLAGS="-Xfrontend -debug-time-compilation -Xfrontend -debug-time-function-bodies"
```

## Best Practices

### Build Hygiene
- Use consistent Swift version across project
- Keep dependencies updated and minimal
- Implement proper code signing strategy
- Use build configurations for environment differences
- Regular clean builds to catch dependency issues
- Monitor build times and optimize bottlenecks

### Continuous Integration Preparation
- Ensure builds work from command line
- Document all build dependencies
- Use version-controlled build scripts
- Test on clean environments regularly
- Maintain reproducible builds across team members