# Go Packaging System

## Overview

Go's packaging system is built around modules and packages, providing a clean, hierarchical organization of code with explicit dependency management. The system emphasizes simplicity, reproducibility, and security in dependency resolution.

## Package Structure

### Package Definition
```go
// Package declaration (must be first non-comment line)
package main  // Executable package

package mypackage  // Library package

package mypackage_test  // External test package
```

### Package Naming Conventions
```go
// Good package names
package user     // Short, descriptive
package http     // Standard library style
package json     // Clear abbreviation

// Avoid
package userPackage  // Redundant "Package"
package user_data    // Underscores
package userData     // CamelCase
```

### Package Organization
```
myproject/
├── go.mod                  # Module definition
├── go.sum                  # Dependency checksums
├── main.go                 # Main executable
├── README.md
├── cmd/                    # Command-line applications
│   ├── server/
│   │   └── main.go
│   └── client/
│       └── main.go
├── internal/               # Private packages
│   ├── auth/
│   ├── database/
│   └── config/
├── pkg/                    # Public packages
│   ├── api/
│   └── utils/
├── api/                    # API definitions (protobuf, OpenAPI)
├── web/                    # Web assets
├── scripts/                # Build/deployment scripts
├── docs/                   # Documentation
└── test/                   # Additional test files
```

## Go Modules

### Module Initialization
```bash
# Initialize new module
go mod init example.com/myproject

# Initialize with VCS inference
go mod init  # Uses git remote URL

# Example module path formats
go mod init github.com/username/project
go mod init gitlab.com/company/project
go mod init example.com/internal/service
```

### go.mod File Structure
```go
module example.com/myproject

go 1.21  // Minimum Go version

require (
    github.com/gin-gonic/gin v1.9.1
    github.com/stretchr/testify v1.8.4
)

require (
    // Indirect dependencies (managed automatically)
    github.com/bytedance/sonic v1.9.1 // indirect
    github.com/chenzhuoyu/base64x v0.0.0-20221115062448-fe3a3abad311 // indirect
    // ... more indirect dependencies
)

exclude (
    // Exclude specific versions
    github.com/problematic/package v1.2.3
)

replace (
    // Replace with local or different version
    github.com/old/package => github.com/new/package v2.0.0
    github.com/local/package => ./local/path
    github.com/fork/package => github.com/myfork/package v1.0.0
)

retract (
    // Mark versions as retracted
    v1.0.0 // Published accidentally
    [v1.1.0, v1.2.0] // Range of bad versions
)
```

### Semantic Import Versioning
```go
// Major version 0 and 1
import "github.com/user/repo"

// Major version 2+
import "github.com/user/repo/v2"
import "github.com/user/repo/v3"

// In go.mod
module github.com/user/repo/v2
```

## Dependency Management

### Adding Dependencies
```bash
# Add latest version
go get github.com/gin-gonic/gin

# Add specific version
go get github.com/gin-gonic/gin@v1.9.1

# Add specific commit
go get github.com/gin-gonic/gin@a1b2c3d

# Add from branch
go get github.com/gin-gonic/gin@main

# Add with version constraints
go get github.com/gin-gonic/gin@latest
go get github.com/gin-gonic/gin@">v1.8.0"
```

### Updating Dependencies
```bash
# Update all dependencies to latest
go get -u ./...

# Update specific package
go get -u github.com/gin-gonic/gin

# Update to patch releases only
go get -u=patch ./...

# Update and add missing dependencies
go mod tidy
```

### Dependency Commands
```bash
# Download dependencies
go mod download

# Verify dependencies
go mod verify

# Show dependency graph
go mod graph

# Explain why dependency is needed
go mod why github.com/gin-gonic/gin

# Show available versions
go list -m -versions github.com/gin-gonic/gin

# Show module information
go list -m all
```

## Package Visibility

### Export Rules
```go
package mypackage

// Exported (public) - starts with capital letter
var PublicVar = "visible outside package"
const PublicConst = 42

type PublicStruct struct {
    PublicField    string
    privateField   string  // Not exported within struct
}

func PublicFunction() {
    // Can access both public and private within same package
    privateFunction()
    fmt.Println(privateVar)
}

// Not exported (private) - starts with lowercase
var privateVar = "only visible within package"
const privateConst = 24

type privateStruct struct {
    field string
}

func privateFunction() {
    // Implementation
}
```

### Internal Packages
```go
// Directory structure enforces visibility
project/
├── internal/        # Only accessible within project
│   └── auth/
├── pkg/
│   └── public/     # Publicly accessible
└── main.go

// Can import from same project
import "project/internal/auth"  // OK from within project

// Cannot import from external project
import "github.com/other/project/internal/auth"  // Compilation error
```

## Package Import System

### Import Declarations
```go
package main

import (
    // Standard library
    "fmt"
    "net/http"
    
    // Third-party packages
    "github.com/gin-gonic/gin"
    "github.com/stretchr/testify/assert"
    
    // Local packages
    "myproject/internal/config"
    "myproject/pkg/utils"
)

// Import aliases
import (
    f "fmt"                    // Alias
    _ "database/sql/driver"    // Import for side effects only
    . "math"                   // Import into current namespace (rare)
    http2 "golang.org/x/net/http2"  // Disambiguate
)
```

### Import Path Resolution
```go
// Standard library packages
import "fmt"           // Built-in package
import "net/http"      // Standard library

// Module-relative imports
import "mymodule/internal/auth"     // From module root
import "mymodule/pkg/utils"         // From module root

// Fully qualified imports
import "github.com/user/repo/pkg/api"     // External module
import "example.com/internal/service"      // Private module
```

## Package Documentation

### Package-level Documentation
```go
// Package math provides basic mathematical operations and constants.
//
// This package implements common mathematical functions including
// trigonometric, logarithmic, and statistical operations.
//
// Example usage:
//    result := math.Add(5, 3)
//    fmt.Printf("5 + 3 = %d\n", result)
package math

// Version information
const Version = "1.2.3"
```

### Example Functions
```go
package math_test

import (
    "fmt"
    "math"
)

func ExampleAdd() {
    result := math.Add(2, 3)
    fmt.Printf("2 + 3 = %d", result)
    // Output: 2 + 3 = 5
}

func ExampleCalculator_Divide() {
    calc := math.NewCalculator()
    result, err := calc.Divide(10, 2)
    if err != nil {
        panic(err)
    }
    fmt.Printf("10 / 2 = %.1f", result)
    // Output: 10 / 2 = 5.0
}
```

## Build Constraints and Tags

### Build Tags
```go
// File: config_dev.go
// +build dev
// +build !prod

package config

const Environment = "development"
const Debug = true
```

```go
// File: config_prod.go
// +build prod
// +build !dev

package config

const Environment = "production"
const Debug = false
```

### Go Generate Directives
```go
package models

//go:generate stringer -type=Status
type Status int

const (
    Pending Status = iota
    Running
    Completed
    Failed
)

//go:generate mockgen -source=interface.go -destination=mocks/mock.go
type UserService interface {
    GetUser(id string) (*User, error)
    CreateUser(user *User) error
}
```

### Embed Files (Go 1.16+)
```go
package web

import (
    _ "embed"
    "embed"
)

// Embed single file
//go:embed templates/index.html
var indexTemplate string

// Embed multiple files
//go:embed static/*
var staticFiles embed.FS

// Embed with subdirectories
//go:embed assets
var assets embed.FS

func ServeStatic() {
    // Use embedded files
    http.FileServer(http.FS(staticFiles))
}
```

## Package Testing

### Test Package Organization
```go
// Internal tests (same package)
// File: math.go
package math

func Add(a, b int) int {
    return a + b
}

// File: math_test.go
package math

func TestAdd(t *testing.T) {
    result := Add(2, 3)  // Can access private functions
    if result != 5 {
        t.Errorf("Expected 5, got %d", result)
    }
}
```

```go
// External tests (different package)
// File: math_external_test.go
package math_test

import (
    "testing"
    "myproject/math"
)

func TestAddExternal(t *testing.T) {
    result := math.Add(2, 3)  // Only public API accessible
    if result != 5 {
        t.Errorf("Expected 5, got %d", result)
    }
}
```

### Test Coverage
```bash
# Run tests with coverage
go test -cover ./...

# Generate coverage profile
go test -coverprofile=coverage.out ./...

# View coverage in browser
go tool cover -html=coverage.out

# Coverage by package
go test -cover -coverprofile=coverage.out ./...
go tool cover -func=coverage.out
```

## Package Publishing

### Version Tagging
```bash
# Create version tags
git tag v1.0.0
git tag v1.0.1
git tag v2.0.0  # Major version bump

# Push tags
git push origin v1.0.0
git push origin --tags

# Delete tag
git tag -d v1.0.0
git push origin --delete v1.0.0
```

### Module Proxy and Checksums
```bash
# Set proxy settings
export GOPROXY=https://proxy.golang.org,direct
export GOSUMDB=sum.golang.org

# Disable proxy (use direct)
export GOPROXY=direct

# Private modules
export GOPRIVATE=github.com/company/*

# Module checksum verification
go mod verify
go clean -modcache  # Clear module cache
```

### Publishing Checklist
```go
// 1. Proper module name in go.mod
module github.com/user/package

// 2. Semantic versioning
git tag v1.0.0

// 3. Public API documentation
// Package mypackage provides...
package mypackage

// 4. Examples and tests
func ExampleFunction() { ... }

// 5. License file
// LICENSE file in repository root

// 6. README with usage examples
// README.md with installation and usage
```

## Advanced Packaging Patterns

### Plugin Architecture
```go
// File: plugin.go
// +build plugin

package main

import "plugin"

func loadPlugin(path string) error {
    p, err := plugin.Open(path)
    if err != nil {
        return err
    }
    
    symbol, err := p.Lookup("Process")
    if err != nil {
        return err
    }
    
    processor := symbol.(func(string) string)
    result := processor("input")
    fmt.Println(result)
    return nil
}
```

### Multi-module Repositories
```
project/
├── go.mod              # Root module
├── api/
│   ├── go.mod          # API module
│   └── v1/
├── client/
│   ├── go.mod          # Client module
│   └── client.go
└── internal/
    └── shared/
```

### Workspace Management (Go 1.18+)
```go
// go.work file
go 1.21

use (
    ./api
    ./client
    ./internal/shared
)

replace github.com/user/api => ./api
```

```bash
# Workspace commands
go work init ./api ./client
go work use ./internal/shared
go work sync
```

## Package Security

### Vulnerability Management
```bash
# Check for vulnerabilities
go install golang.org/x/vuln/cmd/govulncheck@latest
govulncheck ./...

# Update vulnerable dependencies
go get -u github.com/vulnerable/package

# Use go mod tidy to clean up
go mod tidy
```

### Private Module Authentication
```bash
# Configure Git authentication
git config --global url."git@github.com:".insteadOf "https://github.com/"

# Environment variables for authentication
export GOPRIVATE=github.com/company/*
export GONOPROXY=github.com/company/*
export GONOSUMDB=github.com/company/*

# .netrc file for HTTP authentication
echo "machine github.com login username password token" > ~/.netrc
```

### Module Integrity
```bash
# Verify module integrity
go mod verify

# Show module checksums
cat go.sum

# Force checksum recalculation
rm go.sum
go mod tidy
```

## Best Practices

### Package Design Principles
1. **Single Responsibility**: Each package should have a focused purpose
2. **Clear API**: Export only what's necessary
3. **Minimal Dependencies**: Avoid unnecessary external dependencies
4. **Stable Interfaces**: Maintain backward compatibility
5. **Good Documentation**: Document public APIs thoroughly

### Naming Guidelines
```go
// Good package names
package user      // Short, descriptive
package auth      // Clear abbreviation  
package http      // Standard library style

// Package-qualified usage
user.Create()     // Clear with package prefix
auth.Login()      // Obvious what it does
http.Get()        // Standard library pattern
```

### Import Organization
```go
import (
    // 1. Standard library
    "context"
    "fmt"
    "net/http"
    
    // 2. Third-party packages
    "github.com/gin-gonic/gin"
    "github.com/stretchr/testify/assert"
    
    // 3. Local packages
    "myproject/internal/auth"
    "myproject/pkg/utils"
)
```

### Dependency Management Strategy
```go
// 1. Pin major versions in production
require github.com/gin-gonic/gin v1.9.1

// 2. Use go mod tidy regularly
go mod tidy

// 3. Audit dependencies periodically
go list -m -u all

// 4. Vendor for reproducible builds
go mod vendor
```

## Common Patterns and Anti-patterns

### Good Patterns
```go
// Package provides focused functionality
package validator

// Clear, consistent API
func Validate(data interface{}) error { ... }
func ValidateStruct(s interface{}) error { ... }
func ValidateField(field, rule string) error { ... }

// Proper error handling
var (
    ErrInvalidInput = errors.New("invalid input")
    ErrValidationFailed = errors.New("validation failed")
)
```

### Anti-patterns to Avoid
```go
// Avoid: God packages
package utils  // Too broad, unclear purpose

// Avoid: Circular dependencies
// package A imports package B
// package B imports package A

// Avoid: Deep package hierarchies
package deeply/nested/package/structure/that/is/hard/to/navigate
```

## Migration and Compatibility

### Major Version Updates
```go
// v1 module
module github.com/user/package

// v2 module (breaking changes)
module github.com/user/package/v2

// Import both versions
import (
    v1 "github.com/user/package"
    v2 "github.com/user/package/v2"
)
```

### Gradual Migration
```go
// Deprecated functions with migration path
// Deprecated: Use NewFunction instead
func OldFunction() { ... }

func NewFunction() { ... }
```

## Tooling Integration

### IDE Support
```json
// VS Code settings.json
{
    "go.useLanguageServer": true,
    "go.formatTool": "goimports",
    "go.lintTool": "golangci-lint",
    "go.buildOnSave": "package"
}
```

### Linting Configuration
```yaml
# .golangci.yml
run:
  modules-download-mode: readonly

linters-settings:
  goimports:
    local-prefixes: github.com/user/project

linters:
  enable:
    - goimports
    - golint
    - govet
    - ineffassign
    - misspell
```

This comprehensive packaging guide covers all aspects of Go's module and package system, from basic organization to advanced patterns and security considerations, providing everything needed to effectively structure, manage, and distribute Go projects.

## References
- [Go Modules Documentation](https://go.dev/doc/modules/)
- [Package Documentation](https://go.dev/doc/code)
- [Module Release Workflow](https://go.dev/doc/modules/release-workflow)
- [Publishing Modules](https://go.dev/doc/modules/publishing)
- [Module Compatibility](https://go.dev/doc/modules/compatibility)